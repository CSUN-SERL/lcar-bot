<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
<link rel="stylesheet" type="text/css" href="style.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script type="text/javascript" src="http://cdn.robotwebtools.org/EventEmitter2/current/eventemitter2.min.js"></script>
<script type="text/javascript" src="http://cdn.robotwebtools.org/roslibjs/current/roslib.min.js"></script>
<script src="http://maps.google.com/maps/api/js?sensor=false"></script>



  <script>
var longitude =0;
var latitude =0;

 // Connecting to ROS
  // -----------------

 var ros = new ROSLIB.Ros({ //creating ros object
    url : 'ws://localhost:9090'
  });

ros.on('connection', function() {
    console.log('Connected to websocket server.');
  });

  ros.on('error', function(error) {
    console.log('Error connecting to websocket server: ', error);
  });

  ros.on('close', function() {
    console.log('Connection to websocket server closed.');
  });


// Subscribing to a Topic
  // ----------------------


function getCoordinates(){
  var listener = new ROSLIB.Topic({
    ros : ros, 	//ros object connection
    name : 'mavros/global_position/global',
    messageType : 'sensor_msgs/NavSatFix'
  });

   listener.subscribe(function(message) {
   console.log('latitude ' + listener.name + ': ' + message.latitude);
   console.log('longitude ' + listener.name + ': ' + message.longitude);

	longitude = message.longitude;
	latitude = message.latitude;
	console.log('latitude1 ' + longitude);
 	console.log('longitude1 ' + latitude);

	    	//listener.unsubscribe();
  });
}

$(document).ready(function(){

      	  showPosition();
		  getCoordinates();


		  $('#deleteButton').click(function(){
  			deleteMarkers();
	 	  });
});




var x =0;
var map;
var marker;
var newPoint ;
var la ;
var missionDest = []; // way points of destination
var image = {
		      url: 'uavIcon.png',

			 scaledSize: new google.maps.Size(100,100)
			};

function showPosition() {
 console.log('latitude ' + longitude);
   console.log('longitude ' + latitude);

    //lat = position.coords.latitude;
    //lon = position.coords.longitude;
    latlon = new google.maps.LatLng(longitude, latitude)
    mapholder = document.getElementById('mapholder')
    mapholder.style.height = '800px';
    mapholder.style.width = '100%';

    var myOptions = {
    center:latlon,zoom:14,
    mapTypeId:google.maps.MapTypeId.ROADMAP,
    mapTypeControl:true,
    navigationControlOptions:{style:google.maps.NavigationControlStyle.SMALL}
    }

     map = new google.maps.Map(document.getElementById("mapholder"), myOptions);
     marker = new google.maps.Marker({position:latlon,map:map,
									  title:"Drone inbound",
									  icon: image

	});

	map.addListener('click', function(event){
		newMarker(event.latLng);
	});

    update();

}

function update() {

getCoordinates(); //update coordinates

la = new google.maps.LatLng(latitude,
    longitude);

    if (marker) {
      // Marker already created - Move it
      marker.setPosition(la);
    }
    else {
      // Marker does not exist - Create it
      marker = new google.maps.Marker({
        position: la,
        map: map
      });
    }

    // Center the map on the new position depending on the UAV
	var checked = $('input[name=uav]:checked').val();
    console.log(checked);
	if(checked != 'free') { //if its not free roam, then center map to an UAV
    map.setCenter(la);
	}

  outmessage.innerHTML = la ;
  uavName.innerHTML = $("input[name=uav]:checked").val();
   // Call the autoUpdate() function every k seconds
  setTimeout(update, 50);
}

function showError(error) {
    switch(error.code) {
        case error.PERMISSION_DENIED:
            x.innerHTML = "User denied the request for Geolocation."
            break;
        case error.POSITION_UNAVAILABLE:
            x.innerHTML = "Location information is unavailable."
            break;
        case error.TIMEOUT:
            x.innerHTML = "The request to get user location timed out."
            break;
        case error.UNKNOWN_ERROR:
            x.innerHTML = "An unknown error occurred."
            break;
    }
}

function newMarker(location){
 var destination = new google.maps.Marker({
    position: location,
    map: map,
    title: 'Destination: ' + x,

  });

	missionDest.push(destination); //add the destinations to the array.
	x++;
}

// Sets the map on all markers in the array.
function setMapOnAll(map) {
  for (var i = 0; i < missionDest.length; i++) {
    missionDest[i].setMap(map);
  }
}

// Shows any markers currently in the array.
function showMarkers() {
  setMapOnAll(map);
}

// Deletes all markers in the array by removing references to them.
function deleteMarkers() {
	x = 0;
  clearMarkers();
  missionDest = [];
}

// Removes the markers from the map, but keeps them in the array.
function clearMarkers() {
  setMapOnAll(null);
}


console
    </script>
</head>
<body>
 Location(coordinates):
<span id="outmessage"></span>


<center>
<form action="" style="display: inline; ">
  <input type="radio" name="uav" value="free"> free-roam
  <input type="radio" name="uav" value="uav1"> uav1
  <input type="radio" name="uav" value="uav2"> uav2
</form>

</center>
 

<h2 id ="uavName" style="text-align: center;"> </h2>

<div id="mapholder" style = "margin-top: 10px;"></div>




</body>
</html>
