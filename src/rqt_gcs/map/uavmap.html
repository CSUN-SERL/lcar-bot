<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
  <link rel="stylesheet" type="text/css" href="style.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
  <script type="text/javascript" src="http://cdn.robotwebtools.org/EventEmitter2/current/eventemitter2.min.js"></script>
  <script type="text/javascript" src="http://cdn.robotwebtools.org/roslibjs/current/roslib.min.js"></script>
  <script src="http://maps.google.com/maps/api/js?sensor=false"></script>



  <script>
  var longitude = 2; //must be initialized in order to google maps to function
  var latitude  = 2;
  var num =1;
  var listeners =[];

  // Connecting to ROS -----------------
  var ros = new ROSLIB.Ros({ //creating ros object
    url : 'ws://localhost:9090'
  });

  ros.on('connection', function() {
    console.log('Connected to websocket server.');
  });

  ros.on('error', function(error) {
    console.log('Error connecting to websocket server: ', error);
  });

  ros.on('close', function() {
    console.log('Connection to websocket server closed.');
  });



//jQuery waiting for DOM to be ready
$(document).ready(function(){
  showPosition();
});




var x =0;
var map;
var marker =[]; //all UAVs icons will be located here.
var newPoint ;
var la ;    //later and longitude

var image =[];

image[num] = {
  url: 'images/uavIcon' + num + '.png',

  scaledSize: new google.maps.Size(100,100)
};


function showPosition() {


  latlon = new google.maps.LatLng(longitude, latitude)
  mapholder = document.getElementById('mapholder')
  mapholder.style.height = '950px';
  mapholder.style.width = '100%';

  var myOptions = {
    center:latlon,zoom:3,
    mapTypeId:google.maps.MapTypeId.SATELLITE,
    mapTypeControl:true,
    navigationControlOptions:{style:google.maps.NavigationControlStyle.SMALL}
  }

  map = new google.maps.Map(document.getElementById("mapholder"), myOptions);
  marker[num] = new google.maps.Marker({position:latlon,map:map,
    title:"UAV " + num,
    icon: image[num]

  });

  update();

}

function update() {


  listener = new ROSLIB.Topic({
    ros : ros, 	//ros object connection
    name : '/UAV' + num + '/mavros/global_position/global',
    messageType : 'sensor_msgs/NavSatFix'
  });

  listener.subscribe(function(message) {

    if(message.latitude != 0 && message.longitude != 0){ //if not 0
      longitude = message.longitude;
      latitude = message.latitude;

      listener.unsubscribe();
      /*
        The proper way to be subscribe would be to keep the subcription alive
        but there was a lot of bugs and having multiple subscriptions weighted
        down the system thus slowing it down heavily. The work around this was
        to change the global longitude and latitude from a specific node and
        then unsubscribe and keep going with the script.
      */
    }

  });

  if(longitude != 0 && latitude != 0 && $('input[name=uav]').length < num + 1) {
      //if we got good coordinates then create a radiobutton for this uav.

   $('<input />', {
              name: 'uav',
              id: 'uav' + num,
              type: "radio",
              value: num,
          }).appendTo('#radB');

         $('<label />', {
          for: 'uav' + num,
          text: 'uav ' + num + ' ',
      }).appendTo('#radB');

}

//la will hold the coordinates.
  la = new google.maps.LatLng(latitude,
    longitude);

    if (marker[num]) {
      // if Marker already created - Move it
      marker[num].setPosition(la);
        }
    else {
      //else add new image/icon
      image[num] = {
        url: 'images/uavIcon' + num + '.png',
        scaledSize: new google.maps.Size(100,100)
      };

      // Since Marker does not exist - Create it
        marker[num] = new google.maps.Marker({
        position: la,
        map: map,
        title: "UAV " + num,
        icon: image[num]
      });

    }

    /* Center the map on the new position depending on the UAV
       checked will hold the value of the uav we wish to focus
       on.
    */
    var checked = $('input[name=uav]:checked').val();

    if(checked != 'free' && checked != undefined) {
      //if its not free roam, then center map to an UAV
      map.setCenter(marker[checked].getPosition());
    }

    //Display wish UAV is focused.
    outmessage.innerHTML = num + "  " + la ;
    uavName.innerHTML = "UAV " + checked;

    num++
    //increase num to check the next UAV
    if(num >= 11){
      num = 1;
    }


    // Call the autoUpdate() function every k seconds
    setTimeout(update, 200);
  }



  function showError(error) {
    switch(error.code) {
      case error.PERMISSION_DENIED:
      x.innerHTML = "User denied the request for Geolocation."
      break;
      case error.POSITION_UNAVAILABLE:
      x.innerHTML = "Location information is unavailable."
      break;
      case error.TIMEOUT:
      x.innerHTML = "The request to get user location timed out."
      break;
      case error.UNKNOWN_ERROR:
      x.innerHTML = "An unknown error occurred."
      break;
    }
  }


  </script>
</head>
<body>
  Location(coordinates):
  <span id="outmessage"></span>


  <center>

    <form id = "radB" name="rform" action="" style="display: inline; ">
      <input type="radio" name="uav" value="free"> free-roam

    </form>


  </center>


  <h2 id ="uavName" style="text-align: center;"> </h2>

  <div id="mapholder" style = "margin-top: 10px;"></div>


</body>
</html>
