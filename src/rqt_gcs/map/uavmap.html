<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
  <link rel="stylesheet" type="text/css" href="style.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
  <script type="text/javascript" src="http://cdn.robotwebtools.org/EventEmitter2/current/eventemitter2.min.js"></script>
  <script type="text/javascript" src="http://cdn.robotwebtools.org/roslibjs/current/roslib.min.js"></script>
  <script src="http://maps.google.com/maps/api/js?sensor=false"></script>



  <script>
  var longitude = 2;
  var latitude  = 2;
  var num =1;
  var listeners =[];
  var total = 100;
  var sections = total/10;
  var done = false;

  // Connecting to ROS
  // -----------------

  var ros = new ROSLIB.Ros({ //creating ros object
    url : 'ws://localhost:9090'
  });

  ros.on('connection', function() {
    console.log('Connected to websocket server.');
  });

  ros.on('error', function(error) {
    console.log('Error connecting to websocket server: ', error);
  });

  ros.on('close', function() {
    console.log('Connection to websocket server closed.');
  });




$(document).ready(function(){
  showPosition();
});




var x =0;
var map;
var marker =[];
var newPoint ;
var la ;
var squadCreation = 1;
var team = ["Alpha", "Beta", "Shield", "Raid", "Airborne", "Batman", "Daemon", "Nemesis", "Viper", "Cyclone" ];

var image =[];
var list = 0;
var limit =0;

image[num] = {
  url: 'images/uavIcon' + num + '.png',

  scaledSize: new google.maps.Size(60,60)
};


function showPosition() {
//  console.log('latitude ' + longitude);
  // console.log('longitude ' + latitude);


  latlon = new google.maps.LatLng(longitude, latitude)
  mapholder = document.getElementById('mapholder')
  mapholder.style.height = '800px';
  mapholder.style.width = '100%';


  var myOptions = {
    center:latlon,zoom:10,
    mapTypeId:google.maps.MapTypeId.SATELLITE,
    mapTypeControl:true,
    navigationControlOptions:{style:google.maps.NavigationControlStyle.SMALL}
  }

  map = new google.maps.Map(document.getElementById("mapholder"), myOptions);
  marker[num] = new google.maps.Marker({position:latlon,map:map,
    title:"UAV " + num,
    icon: image[num]

  });
 //setTimeout("update()", 4000)
 update();

}

function update() {



  listener = new ROSLIB.Topic({
    ros : ros, 	//ros object connection
    name : '/UAV' + num + '/mavros/global_position/global',
    messageType : 'sensor_msgs/NavSatFix'
  });

  listener.subscribe(function(message) {

    if(message.latitude != 0 && message.longitude != 0){ //if not 0
      longitude = message.longitude;
      latitude = message.latitude;

      listener.unsubscribe();
    }

  });

  if(longitude != 0 && latitude != 0 && $('input[name=uav]').length < num + 1)  {
      //create select list buttons
      console.log("squadCreation: " + squadCreation);
      if(squadCreation == 10){
        squadCreation = 0;
      }

      if(squadCreation == 0 && limit < 10 && done == false) {

        $('<select />', {
          id: team[list],
          name : team[list],
          value: team[list],
        }).appendTo('#radB');
        $('<input />', {
                   name: 'uav',
                   id: 'uav' + num,
                   type: "radio",
                   value: num,
               }).appendTo('#radB');

              $('<label />', {
               for: 'uav' + num,
               text: 'uav ' + num + ' ',
           }).appendTo('#'+team[list]);
        list++;
        limit++;
      }

if(limit <= sections && done == false){
    if(list-1 == 0){
      $('#Alpha').append($('<option>', {
       value:team[list-1] + squadCreation,
       text :  team[list-1] + " " +  squadCreation
   }));


 }
 if(list-1 == 1){
 $('#Beta').append($('<option>', {
  value:team[list-1] + squadCreation,
  text : team[list-1] + " " + squadCreation
}));
}
if(list-1 == 2){
$('#Shield').append($('<option>', {
 value:team[list-1] + squadCreation,
 text :team[list-1] + " " + squadCreation
}));
}
if(list-1 == 3){
$('#Raid').append($('<option>', {
 value:team[list-1] + squadCreation,
 text : team[list-1] + " " + squadCreation
}));
}

if(list-1 == 4){
$('#Airborne').append($('<option>', {
 value:team[list-1] + squadCreation,
 text : team[list-1] + " " + squadCreation
}));
}
if(list-1 == 5){
$('#Batman').append($('<option>', {
 value:team[list-1] + squadCreation,
 text :team[list-1] + " " + squadCreation
}));
}
if(list-1 == 6){
$('#Daemon').append($('<option>', {
 value:team[list-1] + squadCreation,
 text :team[list-1] + " " + squadCreation
}));
}
if(list-1 == 7){
$('#Nemesis').append($('<option>', {
 value:team[list-1] + squadCreation,
 text :team[list-1] + " " + squadCreation
}));
}
if(list-1 == 8){
$('#Viper').append($('<option>', {
 value:team[list-1] + squadCreation,
 text : team[list-1] + " " + squadCreation
}));
}
if(list-1 == 9){
$('#Cyclone').append($('<option>', {
 value:team[list-1] + squadCreation,
 text :team[list-1] + " " + squadCreation
}));
}
}
      //console.log(team[list]);

      //nameThem(list, squadCreation); //create option

console.log(list + " this");




   /* $('<input />', {
              name: 'uav',
              id: 'uav' + num,
              type: "radio",
              value: num,
          }).appendTo('#radB');

         $('<label />', {
          for: 'uav' + num,
          text: 'uav ' + num + ' ',
      }).appendTo('#radB');
*/
}

  console.log("lat: " + latitude);
  console.log("lon: " + longitude);
  la = new google.maps.LatLng(latitude,
    longitude);

    if (marker[num]) {
      // Marker already created - Move it
      marker[num].setPosition(la);
    //  console.log("OLD" + num);
    }
    else {
      //add new image
      if(num > 10){
        image[num] = {
          url: 'images/uavIcon1.png',
          scaledSize: new google.maps.Size(60,60)
        };
      }else{
      image[num] = {
        url: 'images/uavIcon' + num + '.png',
        scaledSize: new google.maps.Size(60,60)
      };
    }

      // Marker does not exist - Create it
        marker[num] = new google.maps.Marker({
        position: la,
        map: map,
        title: "UAV " + num,
        icon: image[num]
      });
      //console.log("NEW" + num);
    }

    // Center the map on the new position depending on the UAV
    var checked = $('input[name=uav]:checked').val();
    console.log(checked);
    if(checked != 'free' && checked != undefined) { //if its not free roam, then center map to an UAV
      map.setCenter(marker[checked].getPosition());
    }
    else{
    //nothing
    }

    outmessage.innerHTML = num + "  " + la ;
    uavName.innerHTML = "UAV " + checked;

    num++
    if(squadCreation <= 10){
    squadCreation++;
  }
  else {
    done = true;
  }

    if(num > total){
      num = 1;
    }


    // Call the autoUpdate() function every k seconds
    setTimeout(update,80);
    //optimal 100
  }



  function showError(error) {
    switch(error.code) {
      case error.PERMISSION_DENIED:
      x.innerHTML = "User denied the request for Geolocation."
      break;
      case error.POSITION_UNAVAILABLE:
      x.innerHTML = "Location information is unavailable."
      break;
      case error.TIMEOUT:
      x.innerHTML = "The request to get user location timed out."
      break;
      case error.UNKNOWN_ERROR:
      x.innerHTML = "An unknown error occurred."
      break;
    }
  }

  function nameThem( x, squadCreation ) {

    //Alpha", "Beta", "Shield", "Raid", "Airborne", "Batman", "Daemon", "Nemesis", "Viper", "Cyclone"

}


  </script>
</head>
<body>
  Location(coordinates):
  <span id="outmessage"></span>


  <center>

    <form id = "radB" name="rform" action="" style="display: inline; ">
      <input type="radio" name="uav" value="free"> <span style="color: red">free-roam </span>

    </form>


  </center>


  <h2 id ="uavName" style="text-align: center;"> </h2>

  <div id="mapholder" style = "margin-top: 10px;"></div>


</body>
</html>
