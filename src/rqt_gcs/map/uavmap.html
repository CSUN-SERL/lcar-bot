<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
  <link rel="stylesheet" type="text/css" href="style.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
  <script type="text/javascript" src="http://cdn.robotwebtools.org/EventEmitter2/current/eventemitter2.min.js"></script>
  <script type="text/javascript" src="http://cdn.robotwebtools.org/roslibjs/current/roslib.min.js"></script>
  <script src="http://maps.google.com/maps/api/js?sensor=false"></script>



  <script>
  var longitude ;
  var latitude ;
  var num =1;
  var listeners =[];

  // Connecting to ROS
  // -----------------

  var ros = new ROSLIB.Ros({ //creating ros object
    url : 'ws://localhost:9090'
  });

  ros.on('connection', function() {
    console.log('Connected to websocket server.');
  });

  ros.on('error', function(error) {
    console.log('Error connecting to websocket server: ', error);
  });

  ros.on('close', function() {
    console.log('Connection to websocket server closed.');
  });


  // Subscribing to a Topic
  // ----------------------
  //function getCoordinates(i){

  /* var listener = new ROSLIB.Topic({
  ros : ros, 	//ros object connection
  name : '/UAV' + num + '/mavros/global_position/global',
  messageType : 'sensor_msgs/NavSatFix'
});

listener.subscribe(function(message) {
//console.log('latitude ' + listener.name + ': ' + message.latitude);
// console.log('longitude ' + listener.name + ': ' + message.longitude);
if(message.latitude != 0 && message.longitude != 0){ //if not 0
longitude = message.longitude;
latitude = message.latitude;
console.log('latitude1 ' + longitude);
console.log('longitude1 ' + latitude);
}else{
listener.unsubscribe();
}
});
*/
//}

$(document).ready(function(){

  showPosition();




});




var x =0;
var map;
var marker =[];
var newPoint ;
var la ;
var image = {
  url: 'uavIcon.png',

  scaledSize: new google.maps.Size(100,100)
};

var image1 = {
  url: 'uav.png',

  scaledSize: new google.maps.Size(100,100)
};

function showPosition() {
  //console.log('latitude ' + longitude);
  // console.log('longitude ' + latitude);


  latlon = new google.maps.LatLng(longitude, latitude)
  mapholder = document.getElementById('mapholder')
  mapholder.style.height = '800px';
  mapholder.style.width = '100%';

  var myOptions = {
    center:latlon,zoom:10,
    mapTypeId:google.maps.MapTypeId.ROADMAP,
    mapTypeControl:true,
    navigationControlOptions:{style:google.maps.NavigationControlStyle.SMALL}
  }

  map = new google.maps.Map(document.getElementById("mapholder"), myOptions);
  marker[num] = new google.maps.Marker({position:latlon,map:map,
    title:"UAV " + num,
    icon: image

  });



  /* -------------START TOPIC CONNECTION ------------------- */





  update();

}

function update() {

  //for (var i = 1; i <= 5; i++) {
  //num = i;
  //save the connections in an array
  listener = new ROSLIB.Topic({
    ros : ros, 	//ros object connection
    name : '/UAV' + num + '/mavros/global_position/global',
    messageType : 'sensor_msgs/NavSatFix'
  });

  listener.subscribe(function(message) {
    //console.log('latitude ' + listener.name + ': ' + message.latitude);
    // console.log('longitude ' + listener.name + ': ' + message.longitude);
    if(message.latitude != 0 && message.longitude != 0){ //if not 0
      longitude = message.longitude;
      latitude = message.latitude;
      //console.log('longitude ' + num + ': ' + longitude[num]);
      // console.log('latitude ' + num + ': ' + latitude[num]);
      listener.unsubscribe();
    }
    //else{

    //}
  });



  console.log("lat: " + latitude);
  console.log("lon: " + longitude);
  la = new google.maps.LatLng(latitude,
    longitude);

    if (marker[num]) {
      // Marker already created - Move it
      marker[num].setPosition(la);
      console.log("OLD" + num);
    }
    else {
      // Marker does not exist - Create it
      marker[num] = new google.maps.Marker({
        position: la,
        map: map,
        title: "UAV " + num,
        icon: image1
      });
      console.log("NEW" + num);
    }

    // Center the map on the new position depending on the UAV
    var checked = $('input[name=uav]:checked').val();
    //console.log(checked);
    if(checked != 'free') { //if its not free roam, then center map to an UAV
      map.setCenter(la);
    }
    else{
      map.setCenter(marker[checked]);
    }

    outmessage.innerHTML = num + "  " + la ;
    uavName.innerHTML = $("input[name=uav]:checked").val();

    num++
    if(num >= 11){
      num = 1;
    }


    // Call the autoUpdate() function every k seconds
    setTimeout(update, 160);
  }



  function showError(error) {
    switch(error.code) {
      case error.PERMISSION_DENIED:
      x.innerHTML = "User denied the request for Geolocation."
      break;
      case error.POSITION_UNAVAILABLE:
      x.innerHTML = "Location information is unavailable."
      break;
      case error.TIMEOUT:
      x.innerHTML = "The request to get user location timed out."
      break;
      case error.UNKNOWN_ERROR:
      x.innerHTML = "An unknown error occurred."
      break;
    }
  }






  </script>
</head>
<body>
  Location(coordinates):
  <span id="outmessage"></span>


  <center>
    <form name="rform action="" style="display: inline; ">
      <input type="radio" name="uav" value="free"> free-roam
      <input type="radio" name="uav" value="1"> uav1
      <input type="radio" name="uav" value="2"> uav2
    </form>

  </center>


  <h2 id ="uavName" style="text-align: center;"> </h2>

  <div id="mapholder" style = "margin-top: 10px;"></div>




</body>
</html>
